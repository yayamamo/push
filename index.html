<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title></title>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="http://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
<script type="text/javascript" src="http://uedayou.net/SPARQLTimeliner/js_sparql/sparql.js" charset="UTF-8"></script>
<script type="text/javascript" src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<style>
#workingNow{
    border:1px dashed #999;
    padding:15px;
    position: fixed;
    top:20%;
    left:30%;
    background-color:#FFF;
    filter: alpha(opacity=85);
    -moz-opacity:0.85;
    opacity:0.85;
}
#workingNow .workingMsg{
    text-align:center;
    padding-top:80px;
    width:100px;
    /* background-image:url("workingNow.gif"); */
    background-position: center top;
    background-repeat: no-repeat;
}
</style>
</head>
<body>
<div class="container">
  <div class="row"><div class="col-xs-12 col-md-12">
  <div class="page-header"><h1>自治体RSS解析</h1></div>
  <p class="lead">各自治体の配信しているRSS情報について、その内容のカテゴリ毎に件数の多い上位10自治体を列挙します。</p>
  <p>全国の様々な自治体が、関連するイベントや行政情報をRSSを用いて配信しています。
  自治体から配信される情報は、その内容に基づいてそれぞれの自治体により分類されておりますが、一般的に共通して「子育て」などのカテゴリ名を付けることができます。
  そこで、各カテゴリにおいて配信されている情報数の多い自治体を列挙する本ウェブアプリケーションを開発しました。
  <p></p>
  <!-- <div class="alert alert-warning" role="warning">
	<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
  </div> -->
  <form>
  	<div class="form-group">
  		<label for="disabledSelect">カテゴリ</label>
  		<select id="category" class="form-control" onchange="processText($('#category').val())">
  			<option value="event">イベント・観光</option>
  			<option value="gov">行政情報</option>
  			<option value="life">暮らし</option>
  			<option value="child">子育て</option>
  			<option value="biz">事業者向け</option>
  			<option value="health">健康</option>
  			<option value="town">まちづくり、環境・緑化</option>
  			<option value="job">しごと情報(雇用・労働)</option>
  			<option value="bid">入札情報</option>
  			<option value="senior">高齢者の方へ</option>
  			<option value="handicap">障がいのある方へ</option>
  			<option value="other">市民の方へ（その他）</option>
  		</select>
  	</div>
		<div class="form-group">
			<button class="btn btn-primary btn-lg" type="button" id="exec_button" onclick="processText($('#category').val())">実行</button>
  	</div>
  	<p><strong>あるいは、</strong></p>
  	<div class="form-group">
  		<label for="freeText">検索用キーワード</label>
  		<input type="keyword" class="form-control" id="freeword">
  		<p>特定のキーワードを含む配信情報について件数を確認したい場合にご利用ください。</p>
  	</div>
  </form>
  	<div id="convtable_area" class="well well-sm center-block">
  		<table id="convtable" class="table table-condensed">
  			<caption><b>結果</b> (最初の最大10件分)</caption>
  			<thead><tr><th>自治体</th><th>件数</th></tr></thead>
  			<tbody></tbody></table>
  	</div>
  </div></div>
</div>
</body>
<script type="text/javascript">
var result_count = 0;
$('#convtable_area').hide();
var resultset = [];

var processText = function(txt,type) {
	result_count = 0;
	resultset = [];
	$('#exec_button').hide();
	dispWorking("処理中");
	issueQuery(txt,type);
	chkCompletion();
};

var mkQuery = function(category) {
	return 'PREFIX : <http://lodosaka.jp/property#>\n' +
	'SELECT ?l (count(?l) as ?lc) ?area {\n' +
	'?s :category "' + category + '" ;\n' +
	':area_label ?l ;\n' +
	':area ?area .\n' +
	'} group by ?l ?area order by desc(?lc)'
};

var mkQuery2 = function(keyword) {
	return 'PREFIX : <http://lodosaka.jp/property#>\n' +
	'SELECT ?l (count(?l) as ?lc) ?area {\n' +
	'?s :area_label ?l ;\n' +
	':area ?area ;\n' +
	' <http://purl.org/rss/2.0/title> ?t.' +
	'FILTER contains(?t, "' + keyword + '")' +
	'} group by ?l ?area order by desc(?lc)'
};

var issueQuery = function(q, t) {
	qr = sendQuery("http://lod.hozo.jp/repositories/CHOsaka", mkQuery(q));
	qr.fail(
		function (xhr, textStatus, thrownError) {
		}
	);
	qr.done(
		function (d) {
			if (d.results.bindings instanceof Array) {
				for (var dt = 0; dt < d.results.bindings.length; dt++) {
					resultset.push({
						'area_label' : d.results.bindings[dt]['l'].value,
						'count' : d.results.bindings[dt]['lc'].value,
						'area' : d.results.bindings[dt]['area'].value
					});
				}
			}
			result_count = 1;
		}
	);
};

var chkCompletion = function(){
	if(result_count == 1){
		$('#convtable tbody').remove();
		for (var idx in resultset){
			if(idx < 10){ // 最初の10件のみ表示
				$('#convtable').append('<tr>' + '</tr>');
				$('#convtable tr:last')
					.append('<td><a href="http://push.jp.net/koho/index.html?area=' + resultset[idx]['area'] + '">' + resultset[idx]['area_label'] + '</a></td><td>' + resultset[idx]['count'] + '</td>');
			}
			removeWorking();
			$('#convtable_area').show();
		}
	}else{
		setTimeout('chkCompletion()',1000);
	}
};

var dispWorking = function(m){
	var disp_msg = "";
	if( m != ""){
		disp_msg = "<div class='workingMsg'>" + m + "</div>"; 
	}
	if($("#workingNow").size() == 0){
		$("body").append("<div id='workingNow'>" + disp_msg + "</div>");
	}
};

var removeWorking = function(){
	$('#workingNow').remove();
};
</script>
</html>
