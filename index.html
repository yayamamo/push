<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title></title>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="http://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
<script type="text/javascript" src="http://uedayou.net/SPARQLTimeliner/js_sparql/sparql.js" charset="UTF-8"></script>
<script type="text/javascript" src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<style>
#workingNow{
    border:1px dashed #999;
    padding:15px;
    position: fixed;
    top:20%;
    left:30%;
    background-color:#FFF;
    filter: alpha(opacity=85);
    -moz-opacity:0.85;
    opacity:0.85;
}
#workingNow .workingMsg{
    text-align:center;
    padding-top:80px;
    width:100px;
    background-image:url("workingNow.gif");
    background-position: center top;
    background-repeat: no-repeat;
}
#file-input div.input {
    padding: 20px;
    border: none 1px #555;
    width: 100px;
    height: 100px;
    background-color: #fff;
    background-image:url("drug_and_drop.png");
    background-position: center center;
    background-repeat: no-repeat;
}
</style>
</head>
<body>
<div class="container">
  <div class="row"><div class="col-xs-12 col-md-12">
  <div class="page-header"><h1>自治体RSS解析</h1></div>
  <p class="lead">説明</p>
  <p></p>
  <!-- <div class="alert alert-warning" role="warning">
	<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
  </div> -->
  <form><div class="form-group">
	<label>SPARQLエンドポイント:</label>
	<input id="endpoint" class="form-control" value="http://lod.hozo.jp/repositories/CHOsaka" type="text">
	</div>
	<div class="form-group">
		<button class="btn btn-primary btn-lg" type="button" id="exec_button" onclick="exec()">割当実行</button>
  	</div></form>
  	<div id="convtable_area" class="well well-sm center-block">
  		<table id="convtable" class="table table-condensed">
  			<caption><b>結果</b> (最初の最大10件分)</caption>
  			<thead><tr><th>自治体</th><th>件数</th></tr></thead>
  			<tbody></tbody></table>
  	</div>
  </div></div>
</div>
</body>
<script type="text/javascript">
var result_count;
var total_count;
$('#download_div').hide();
$('#convtable_area').hide();
var resultset= [];

$(function() {
	var inEle = $('#file-input div.input');

	inEle
	.on('dragenter', function(e) {
		e.preventDefault();
	})
	.on('dragover', function(e){
		e.preventDefault();
	})
	.on('drop', function(e){
		e.preventDefault();
		var files = e.originalEvent.dataTransfer.files;
		for (var i=0; i<files.length; i++) {
			if (files[i].type === 'text/plain') {
				var reader = new FileReader();
				reader.onerror = function(e) {
					console.log('error', e.target.error.code);
				}
				reader.onload = function(e){
					processText(e.target.result);
				};
				reader.readAsText(files[i], 'UTF-8');
		 	}
		}
	});
});
		 
var exec = function() {
	processText($('#literal').val());
};

var processText = function(txt) {
	$('#file-input').hide();
	$('#exec_button').hide();
	dispWorking("処理中");
	rows = txt.split("\n");
	result_count = 0;
	total_count = rows.length;
	for ( var r in rows ){
		issueQuery(rows[r], r);
	}
	chkCompletion();
};

var mkQuery = function(cliteral) {
	return 'PREFIX : <http://lodosaka.jp/property#>\n' +
	'SELECT ?l (count(?l) as ?lc) {' +
	'?s :category "event" ;' +
	':area_label ?l .' +
	'} group by ?l order by desc(?lc)'
};

var issueQuery = function(q,i) {
	resultset.push({});
	resultset[i]['area_label'] = "";
	resultset[i]['count'] = "";
	qr = sendQuery($('#endpoint').val(), mkQuery(q));
	qr.fail(
		function (xhr, textStatus, thrownError) {
			result_count++;
		}
	);
	qr.done(
		function (d) {
			if (d.results.bindings instanceof Array) {
				result_count++;
				for (var dt = 0; dt < d.results.bindings.length; dt++) {
					resultset[i]['area_label'] += d.results.bindings[dt]['l'].value;
					resultset[i]['count'] += d.results.bindings[dt]['lc'].value;
				}
			}
		}
	);
};

var chkCompletion = function(){
	if(result_count == total_count){
		var out = "";
		for (var idx in resultset){
			if(idx < 10){ // 最初の10件のみ表示
				$('#convtable').append('<tr>' + '</tr>');
				$('#convtable tr:last')
					.append('<td>' + resultset[idx]['area_label'] + '</td><td>' + resultset[idx]['count'] + '</td>');
			}
		}
		$('#convtable_area').show();
		$('#download_div').show();
	}else{
	   setTimeout('chkCompletion()',1000);
	}
};

var dispWorking = function(m){
	var disp_msg = "";
	if( m != ""){
		disp_msg = "<div class='workingMsg'>" + m + "</div>"; 
	}
	if($("#workingNow").size() == 0){
		$("body").append("<div id='workingNow'>" + disp_msg + "</div>");
	}
};

var removeWorking = function(){
	$('#workingNow').remove();
};
</script>
</html>
