<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title></title>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="http://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
<script type="text/javascript" src="http://uedayou.net/SPARQLTimeliner/js_sparql/sparql.js" charset="UTF-8"></script>
<script type="text/javascript" src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<style>
#workingNow{
    border:1px dashed #999;
    padding:15px;
    position: fixed;
    top:20%;
    left:30%;
    background-color:#FFF;
    filter: alpha(opacity=85);
    -moz-opacity:0.85;
    opacity:0.85;
}
#workingNow .workingMsg{
    text-align:center;
    padding-top:80px;
    width:100px;
    /* background-image:url("workingNow.gif"); */
    background-position: center top;
    background-repeat: no-repeat;
}
</style>
</head>
<body>
<div class="container">
  <div class="row"><div class="col-xs-12 col-md-12">
  <div class="page-header"><h1>自治体RSS解析</h1></div>
  <p class="lead">説明</p>
  <p></p>
  <!-- <div class="alert alert-warning" role="warning">
	<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
  </div> -->
  <form>
  	<div class="form-group">
  		<label for="disabledSelect">カテゴリ</label>
  		<select id="category" class="form-control" onchange="processText($('#category').value)">
  			<option value="event">イベント・観光</option>
  			<option value="gov">行政情報</option>
  			<option value="life">暮らし</option>
  			<option value="child">子育て</option>
  			<option value="biz">事業者向け</option>
  			<option value="health">健康</option>
  			<option value="town">まちづくり、環境・緑化</option>
  			<option value="job">しごと情報(雇用・労働)</option>
  			<option value="bid">入札情報</option>
  			<option value="senior">高齢者の方へ</option>
  			<option value="handicap">障がいのある方へ</option>
  			<option value="other">市民の方へ（その他）</option>
  		</select>
  	</div>
	<div class="form-group">
		<button class="btn btn-primary btn-lg" type="button" id="exec_button" onclick="exec()">実行</button>
  	</div></form>
  	<div id="convtable_area" class="well well-sm center-block">
  		<table id="convtable" class="table table-condensed">
  			<caption><b>結果</b> (最初の最大10件分)</caption>
  			<thead><tr><th>自治体</th><th>件数</th></tr></thead>
  			<tbody></tbody></table>
  	</div>
  </div></div>
</div>
</body>
<script type="text/javascript">
var result_count;
var total_count;
$('#convtable_area').hide();
var resultset= [];

var exec = function() {
	processText($('#category').value);
};

var processText = function(txt) {
	$('#exec_button').hide();
	dispWorking("処理中");
	issueQuery(txt);
	chkCompletion();
};

var mkQuery = function(catebory) {
	return 'PREFIX : <http://lodosaka.jp/property#>\n' +
	'SELECT ?l (count(?l) as ?lc) {\n' +
	'?s :category "event" ;\n' +
	':area_label ?l .\n' +
	'} group by ?l order by desc(?lc)'
};

var issueQuery = function(q) {
	qr = sendQuery("http://lod.hozo.jp/repositories/CHOsaka", mkQuery(q));
	qr.fail(
		function (xhr, textStatus, thrownError) {
		}
	);
	qr.done(
		function (d) {
			if (d.results.bindings instanceof Array) {
				for (var dt = 0; dt < d.results.bindings.length; dt++) {
					resultset.push({
						'area_label' : d.results.bindings[dt]['l'].value,
						'count' : d.results.bindings[dt]['lc'].value
					});
				}
			}
			result_count = 1;
		}
	);
};

var chkCompletion = function(){
	if(result_count == 1){
		for (var idx in resultset){
			if(idx < 10){ // 最初の10件のみ表示
				$('#convtable').append('<tr>' + '</tr>');
				$('#convtable tr:last')
					.append('<td>' + resultset[idx]['area_label'] + '</td><td>' + resultset[idx]['count'] + '</td>');
			}
			removeWorking();
			$('#convtable_area').show();
		}
	}else{
		setTimeout('chkCompletion()',1000);
	}
};

var dispWorking = function(m){
	var disp_msg = "";
	if( m != ""){
		disp_msg = "<div class='workingMsg'>" + m + "</div>"; 
	}
	if($("#workingNow").size() == 0){
		$("body").append("<div id='workingNow'>" + disp_msg + "</div>");
	}
};

var removeWorking = function(){
	$('#workingNow').remove();
};
</script>
</html>
